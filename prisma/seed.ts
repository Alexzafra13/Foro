// prisma/seed.ts - CORREGIDO
import { PrismaClient } from '@prisma/client';
import { genSaltSync, hashSync } from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Iniciando seeding con categor√≠as...');

  try {
    // =========================================
    // 1. ROLES DEL SISTEMA
    // =========================================
    
    console.log('üìù Insertando roles...');
    const rolesData = ['admin', 'moderator', 'user'];

    for (const roleName of rolesData) {
      await prisma.role.upsert({
        where: { name: roleName },
        update: {},
        create: { name: roleName },
      });
    }

    console.log('‚úÖ Roles insertados correctamente');

    // =========================================
    // 2. CATEGOR√çAS DE CANALES
    // =========================================
    
    console.log('üìÅ Creando categor√≠as...');
    
    const categoriesData = [
      { 
        name: 'General', 
        description: 'Canales generales del foro',
        icon: 'üè†', 
        position: 1,
        isVisible: true
      },
      { 
        name: 'Tecnolog√≠a', 
        description: 'Programaci√≥n, hardware y tecnolog√≠a',
        icon: 'üíª', 
        position: 2,
        isVisible: true
      },
      { 
        name: 'Entretenimiento', 
        description: 'Pel√≠culas, series, libros y multimedia',
        icon: 'üé¨', 
        position: 3,
        isVisible: true
      },
      { 
        name: 'Gaming', 
        description: 'Videojuegos en todas sus formas',
        icon: 'üéÆ', 
        position: 4,
        isVisible: true
      },
      { 
        name: 'Creatividad', 
        description: 'Arte, m√∫sica y expresi√≥n creativa',
        icon: 'üé®', 
        position: 5,
        isVisible: true
      },
      { 
        name: 'Varios', 
        description: 'Otros temas de inter√©s',
        icon: 'üåç', 
        position: 6,
        isVisible: true
      },
      { 
        name: 'Staff', 
        description: 'Canales privados del equipo',
        icon: 'üîí', 
        position: 99,
        isVisible: true
      },
    ];

    for (const categoryData of categoriesData) {
      await prisma.category.upsert({
        where: { name: categoryData.name },
        update: { 
          description: categoryData.description,
          icon: categoryData.icon,
          position: categoryData.position,
          isVisible: categoryData.isVisible
        },
        create: {
          name: categoryData.name,
          description: categoryData.description,
          icon: categoryData.icon,
          position: categoryData.position,
          isVisible: categoryData.isVisible
        },
      });
    }

    console.log('‚úÖ Categor√≠as creadas correctamente');

    // =========================================
    // 3. OBTENER IDs DE CATEGOR√çAS
    // =========================================
    
    const generalCategory = await prisma.category.findUnique({ where: { name: 'General' } });
    const techCategory = await prisma.category.findUnique({ where: { name: 'Tecnolog√≠a' } });
    const entertainmentCategory = await prisma.category.findUnique({ where: { name: 'Entretenimiento' } });
    const gamingCategory = await prisma.category.findUnique({ where: { name: 'Gaming' } });
    const creativeCategory = await prisma.category.findUnique({ where: { name: 'Creatividad' } });
    const variosCategory = await prisma.category.findUnique({ where: { name: 'Varios' } });
    const staffCategory = await prisma.category.findUnique({ where: { name: 'Staff' } });

    if (!generalCategory || !techCategory || !entertainmentCategory || 
        !gamingCategory || !creativeCategory || !variosCategory || !staffCategory) {
      throw new Error('Error: No se pudieron crear todas las categor√≠as');
    }

    // =========================================
    // 4. CANALES ORGANIZADOS POR CATEGOR√çA
    // =========================================
    
    console.log('üìù Creando canales organizados...');

    const channelsData = [
      // üè† GENERAL
      { 
        name: 'general', 
        categoryId: generalCategory.id,
        description: 'Discusiones generales y presentaciones', 
        icon: 'üí¨',
        position: 1,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'anuncios', 
        categoryId: generalCategory.id,
        description: 'Anuncios importantes del foro', 
        icon: 'üì¢',
        position: 2,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'sugerencias', 
        categoryId: generalCategory.id,
        description: 'Sugerencias para mejorar el foro', 
        icon: 'üí°',
        position: 3,
        isPrivate: false,
        isVisible: true
      },

      // üíª TECNOLOG√çA
      { 
        name: 'programacion', 
        categoryId: techCategory.id,
        description: 'Desarrollo, frameworks y lenguajes', 
        icon: 'üë®‚Äçüíª',
        position: 1,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'hardware', 
        categoryId: techCategory.id,
        description: 'PCs, componentes y builds', 
        icon: 'üîß',
        position: 2,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'linux', 
        categoryId: techCategory.id,
        description: 'Distribuciones y open source', 
        icon: 'üêß',
        position: 3,
        isPrivate: false,
        isVisible: true
      },

      // üé¨ ENTRETENIMIENTO
      { 
        name: 'peliculas-series', 
        categoryId: entertainmentCategory.id,
        description: 'Recomendaciones y rese√±as', 
        icon: 'üì∫',
        position: 1,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'enlaces-media', 
        categoryId: entertainmentCategory.id,
        description: 'Enlaces a contenido multimedia', 
        icon: 'üîó',
        position: 2,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'libros', 
        categoryId: entertainmentCategory.id,
        description: 'Literatura y recomendaciones', 
        icon: 'üìö',
        position: 3,
        isPrivate: false,
        isVisible: true
      },

      // üéÆ GAMING
      { 
        name: 'juegos-pc', 
        categoryId: gamingCategory.id,
        description: 'Steam, mods y gaming en PC', 
        icon: 'üñ•Ô∏è',
        position: 1,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'juegos-console', 
        categoryId: gamingCategory.id,
        description: 'PlayStation, Xbox, Nintendo', 
        icon: 'üéÆ',
        position: 2,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'juegos-mobile', 
        categoryId: gamingCategory.id,
        description: 'Gaming m√≥vil y casual', 
        icon: 'üì±',
        position: 3,
        isPrivate: false,
        isVisible: true
      },

      // üé® CREATIVIDAD
      { 
        name: 'arte-dise√±o', 
        categoryId: creativeCategory.id,
        description: 'Arte digital y dise√±o gr√°fico', 
        icon: 'üé®',
        position: 1,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'musica', 
        categoryId: creativeCategory.id,
        description: 'G√©neros, artistas y recomendaciones', 
        icon: 'üéµ',
        position: 2,
        isPrivate: false,
        isVisible: true
      },

      // üåç VARIOS
      { 
        name: 'deportes', 
        categoryId: variosCategory.id,
        description: 'F√∫tbol, baloncesto, esports', 
        icon: '‚öΩ',
        position: 1,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'viajes', 
        categoryId: variosCategory.id,
        description: 'Destinos y experiencias', 
        icon: '‚úàÔ∏è',
        position: 2,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'cocina', 
        categoryId: variosCategory.id,
        description: 'Recetas y gastronom√≠a', 
        icon: 'üë®‚Äçüç≥',
        position: 3,
        isPrivate: false,
        isVisible: true
      },
      { 
        name: 'off-topic', 
        categoryId: variosCategory.id,
        description: 'Conversaciones casuales', 
        icon: 'üí≠',
        position: 4,
        isPrivate: false,
        isVisible: true
      },

      // üîí STAFF
      { 
        name: 'moderadores', 
        categoryId: staffCategory.id,
        description: 'Coordinaci√≥n del equipo', 
        icon: 'üëÆ',
        position: 1,
        isPrivate: true,
        isVisible: true
      },
      { 
        name: 'admin', 
        categoryId: staffCategory.id,
        description: 'Gesti√≥n administrativa', 
        icon: '‚öôÔ∏è',
        position: 2,
        isPrivate: true,
        isVisible: true
      },
    ];

    for (const channelData of channelsData) {
      await prisma.channel.upsert({
        where: { name: channelData.name },
        update: { 
          categoryId: channelData.categoryId,
          description: channelData.description,
          icon: channelData.icon,
          position: channelData.position,
          isPrivate: channelData.isPrivate,
          isVisible: channelData.isVisible
        },
        create: {
          name: channelData.name,
          categoryId: channelData.categoryId,
          description: channelData.description,
          icon: channelData.icon,
          position: channelData.position,
          isPrivate: channelData.isPrivate,
          isVisible: channelData.isVisible
        },
      });
    }

    console.log('‚úÖ Canales organizados creados correctamente');

    // =========================================
    // 5. USUARIOS DE DESARROLLO
    // =========================================
    
    if (process.env.NODE_ENV === 'development') {
      console.log('üë§ Creando usuarios de desarrollo...');
      
      const adminRole = await prisma.role.findUnique({ where: { name: 'admin' } });
      const moderatorRole = await prisma.role.findUnique({ where: { name: 'moderator' } });
      const userRole = await prisma.role.findUnique({ where: { name: 'user' } });
      
      if (adminRole && moderatorRole && userRole) {
        // Generar hash correcto para admin123
        const salt = genSaltSync(12);
        const correctPasswordHash = hashSync('admin123', salt);
        
        console.log('üîê Generando hash correcto para contrase√±as...');
        
        // Usuario admin
        await prisma.user.upsert({
          where: { email: 'admin@foro.local' },
          update: {},
          create: {
            username: 'admin',
            email: 'admin@foro.local',
            passwordHash: correctPasswordHash,
            roleId: adminRole.id,
            reputation: 1000,
          },
        });

        // Usuario moderador
        await prisma.user.upsert({
          where: { email: 'mod@foro.local' },
          update: {},
          create: {
            username: 'moderador',
            email: 'mod@foro.local',
            passwordHash: correctPasswordHash,
            roleId: moderatorRole.id,
            reputation: 500,
          },
        });

        // Usuario normal
        await prisma.user.upsert({
          where: { email: 'user@foro.local' },
          update: {},
          create: {
            username: 'usuario_prueba',
            email: 'user@foro.local',
            passwordHash: correctPasswordHash,
            roleId: userRole.id,
            reputation: 100,
          },
        });

        console.log('‚úÖ Usuarios de desarrollo creados:');
        console.log('   ‚Ä¢ admin@foro.local (password: admin123)');
        console.log('   ‚Ä¢ mod@foro.local (password: admin123)');
        console.log('   ‚Ä¢ user@foro.local (password: admin123)');
      }
    }

    // =========================================
    // 6. POSTS DE BIENVENIDA (OPCIONAL)
    // =========================================
    
    if (process.env.NODE_ENV === 'development') {
      console.log('üìù Creando posts de bienvenida...');
      
      const generalChannel = await prisma.channel.findFirst({ 
        where: { name: 'general' } 
      });
      const anunciosChannel = await prisma.channel.findFirst({ 
        where: { name: 'anuncios' } 
      });
      const adminUser = await prisma.user.findFirst({ 
        where: { email: 'admin@foro.local' } 
      });
      
      if (generalChannel && anunciosChannel && adminUser) {
        // Post de bienvenida en anuncios
        await prisma.post.create({
          data: {
            channelId: anunciosChannel.id,
            authorId: adminUser.id,
            title: '¬°Bienvenidos al Foro!',
            content: `¬°Hola y bienvenidos a nuestro foro organizado!

**üìã Normas b√°sicas:**
‚Ä¢ Mant√©n el respeto hacia otros usuarios
‚Ä¢ Publica en el canal apropiado seg√∫n la categor√≠a
‚Ä¢ No spam ni contenido ofensivo
‚Ä¢ ¬°Divi√©rtete y comparte conocimientos!

**üìÅ Nuestras categor√≠as:**
‚Ä¢ üè† **General**: Presentaciones y discusiones generales
‚Ä¢ üíª **Tecnolog√≠a**: Programaci√≥n, hardware, Linux
‚Ä¢ üé¨ **Entretenimiento**: Pel√≠culas, series, libros, enlaces
‚Ä¢ üéÆ **Gaming**: Juegos de PC, consola y m√≥vil
‚Ä¢ üé® **Creatividad**: Arte, m√∫sica y expresi√≥n
‚Ä¢ üåç **Varios**: Deportes, viajes, cocina y m√°s

¬°Esperamos que disfrutes tu estancia aqu√≠!`,
            isPinned: true,
          },
        });

        // Post en general
        await prisma.post.create({
          data: {
            channelId: generalChannel.id,
            authorId: adminUser.id,
            title: 'Pres√©ntate aqu√≠',
            content: '¬°Nuevos usuarios! Este es el lugar perfecto para presentarse y conocer a la comunidad. Cu√©ntanos un poco sobre ti, tus intereses y qu√© te trae por aqu√≠. ¬°Bienvenidos!',
            isPinned: true,
          },
        });

        console.log('‚úÖ Posts de bienvenida creados');
      }
    }

    // =========================================
    // 7. RESUMEN FINAL
    // =========================================
    
    const stats = {
      roles: await prisma.role.count(),
      categories: await prisma.category.count(),
      channels: await prisma.channel.count(),
      users: await prisma.user.count(),
      posts: await prisma.post.count(),
    };

    console.log('\nüéâ ¬°FORO ORGANIZADO CREADO EXITOSAMENTE!');
    console.log('üìä ESTAD√çSTICAS:');
    console.log(`   üîê ${stats.roles} roles`);
    console.log(`   üìÅ ${stats.categories} categor√≠as`);
    console.log(`   üì∫ ${stats.channels} canales`);
    console.log(`   üë• ${stats.users} usuarios`);
    console.log(`   üìù ${stats.posts} posts`);
    
    if (process.env.NODE_ENV === 'development') {
      console.log('\nüîë ACCESOS DE DESARROLLO:');
      console.log('   Admin: admin@foro.local / admin123');
      console.log('   Mod:   mod@foro.local / admin123');  
      console.log('   User:  user@foro.local / admin123');
      console.log('\nüí° Tip: Usa "npx prisma studio" para ver los datos');
    }

  } catch (error) {
    console.error('‚ùå Error durante el seeding:', error);
    throw error;
  }
}

main()
  .catch((e) => {
    console.error('‚ùå Error cr√≠tico:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
    console.log('üîå Conexi√≥n a base de datos cerrada');
  });